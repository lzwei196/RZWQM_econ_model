<html>

<head>
  <link rel="stylesheet" href="content.css">
</head>

<body>
  <div id='carbonPrice'>
  </div>
  <div class="calculate-button" align="center" id="calculate-button">
    <button type="button" class="btn btn-danger btn-rounded" onclick="execute()">Commence RZWQM Simulation</button>
  </div>

  <br>
  <br>

  <div class="calculate-button" align="center" id="nsb-button">
    <button type="button" class="btn btn-danger btn-rounded" onclick="nsbCalc()">Commence Economical analysis</button>
  </div>

  <br>
  <br>

  <div id="revenue">
    <h3 class="nsb-price" align="center">Net Social Benefit(CAD)ï¼š</h3>
  </div>

  <script>
    //loading up the required depenency variable
    var app = require('electron').remote;
    var dialog = require('electron').remote.dialog;
    var fs = require('fs');
    var ProjectDir = '';
    var ss_plant = require('./js/sessionStorage').plant
    var ss_crop_price = require('./js/sessionStorage').cropsWithPrice
    var plugin = require('./js/plugin.js');
    var cropPrice = require('./js/scraper.js').commodityPrice;
    var crop_json = require('./crops.json');
    var bushel_tonne_exchange = require('./bushel_tonne_exchange.json');
    var constantRaw = fs.readFileSync("constants.json");
    var constant = JSON.parse(constantRaw);
    var currency_rate_CAD = JSON.parse(sessionStorage.getItem('currency_rate'))['CAD']

    function readRzwqm() {
      plugin.readRzwqm();
    }

    //user would help to locate the Rzwqm.DAT file first, then with the choice they made, execute the simulation.
    function writeRzwqm() {
      plugin.writeRzwqm();
    }

    function readData() {
      plugin.readData();
    }

    async function scraperFn() {
      //cropInfo();
      let all_crop_price = [];
      var plant_date = JSON.parse(sessionStorage.getItem('plant_date'))
      for (i = 0; i < plant_date.length; i++) {
        var crop_name = Object.values(plant_date[i])[0];
        var crop_date = Object.keys(plant_date[i])[0];
        if (crop_json.hasOwnProperty(crop_name)) {
          var the_crop_price = await cropPrice(crop_json[crop_name]);
          var price = the_crop_price["dataset"]["data"][0][1];
          all_crop_price.push({
            [crop_date]: {
              price: price,
              crop: crop_name
            }
          });
        }
      }
      ss_crop_price(all_crop_price);
    }

    function cropInfo() {
      ProjectDir = JSON.parse(sessionStorage.getItem('projectDirectory'));
      //find the location of the rzwqm file, also reading the data from it
      locate = plugin.locateTheRzwqm(ProjectDir);
      //two varibales that should be returned from calling the function
      let filePath = locate.path;
      let fileData = locate.data;
      var beginLine = fileData.indexOf('=        below as the reference number.') + 3;
      var endLine = fileData.indexOf('=     SITE SPECIFIC PARAMETERS') - 2;
      var begin_plant_line = fileData.indexOf(
        '=    5       planting window in days after plant date (# of days) [0-45]') + 3;
      var end_plant_line = fileData.indexOf(
        '==               M A N U R E   M A N A G E M E N T                    ==') - 3;
      var cropArray = [];
      var plant_date = [];

      for (var i = beginLine; i <= endLine; i++) {
        if (i === beginLine) {
          cropArray.push(fileData[i]);
        } else {
          var splited = fileData[i].split(/(\s+)/);
          cropArray.push(splited[2])
        }
      }

      for (i = begin_plant_line; i <= end_plant_line; i = i + 3) {
        splited = fileData[i].split(/(\s+)/);
        plant_date.push({
          [splited[6]]: cropArray[splited[0]]
        });
      }

      ss_plant(plant_date)
    }

    function execute() {
      //writeRzwqm();
      const exec = require('child_process').exec;
      let stringHere = 'start RZWQMrelease.exe';
      //let stringHere = "C:\\RZWQM2\\projects\\GHG-SE\\GHG-SE-FD\\RZWQMrelease.exe";
      //And run the application from the current folder
      exec(stringHere, {
          cwd: ProjectDir
        },
        function (err, stdout, stderr) {
          if (err) {
            alert(err)
            console.log(err)
          }
          // node couldn't execute the command
          // the *entire* stdout and stderr (buffered)
        });
    }

    async function nsbCalc() {
      var cost_array =[];
      var crop_final_price = JSON.parse(sessionStorage.getItem('cropWithPrice'))
      //read data from the output
      var output = await plugin.readData();
      var yieldRaw = output.yield;

      //console.log(yieldRaw)
      let yield = [];
      var revenue = {};
      let i = 0;

      //taking out the final yield with the the number of the day
      yieldRaw.forEach(function (element, index) {
        if (element != 0 && yieldRaw[index + 1] == 0) {
          yield.push(element);
        }
      })
      //cost should be for each year, which is in nsb per year
      yield.forEach(function (element) {
        let revenue_each = element / 1000 *
          Object.values(crop_final_price[i])[0]['price'] *
        currency_rate_CAD *
        bushel_tonne_exchange[Object.values(crop_final_price[i])[0]['crop']]
        Object.values(crop_final_price[i])[0]['price']
        Object.keys(crop_final_price[i])[0]
        revenue[Object.keys(crop_final_price[i])[0]]=revenue_each
        i = i + 1;
      })


      display_result(nsb)
    }

    function display_result(result) {
      $("#revenue").append('<h3 align="center" >' + result + '</h3>')
    }

    $(document).ready(function () {
      let carbon_tax_cal_QC = model_scheme.carbon_tax_cal_QC;
      db_connection(db,'carbon_tax_cal_QC', carbon_tax_cal_QC, 'year',0)
      cropInfo();
      //writeRzwqm()chr;
      scraperFn();
    })
   </script>

</body>

</html>