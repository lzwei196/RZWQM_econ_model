<html>
        <head>
            <link rel="stylesheet" href="content.css">
        </head>

<body>
  <div id = 'carbonPrice'>
  </div>
      <div class="calculate-button" align = "center" id="calculate-button">
        <button type="button" class="btn btn-danger btn-rounded" onclick="scraperFn()">Commence Simulation</button>
      </div>

      <br>
      <br>

      <div class="calculate-button" align = "center" id="nsb-button">
        <button type="button" class="btn btn-danger btn-rounded" onclick="cropInfo()">Commence Economical analysis</button>
      </div>

      <br>
      <br>

      <div>
        <h3 class="nsb-price" align = "center" >Net Social Benefit$ï¼š</h3>
      </div>

<script>
  //loading up the required depenency variable
    var app = require('electron').remote; 
    var dialog = require('electron').remote.dialog;
    var fs = require('fs');
    var plugin = require('./js/plugin.js');
    var cropPrice = require('./js/scraper.js').commodityPrice;

    var constantRaw = fs.readFileSync("constants.json")
    var constant = JSON.parse(constantRaw)
    var all_crop_price = [];


    function readRzwqm(){
      plugin.readRzwqm();
    }

    //user would help to locate the Rzwqm.DAT file first, then with the choice they made, execute the simulation.
    function writeRzwqm(){
      plugin.writeRzwqm();
    }

    function readData(){
      plugin.readData();
    }
    
    async function scraperFn(){
      let crops = cropInfo();
      
      all_crop_price = await cropPrice('TFGRAIN/CORN.json')
      var price = all_crop_price["dataset"]["data"][0][1]
      return price
    }
   
    function cropInfo(){
      let locateReleaseFile = plugin.locateTheReleaseFile();
      var ProjectDir = JSON.parse(sessionStorage.getItem('projectDirectory'));
      //find the location of the rzwqm file, also reading the data from it
      let locate = plugin.locateTheRzwqm(ProjectDir);
      //two varibales that should be returned from calling the function
      let filePath = locate.path;
      let fileData = locate.data;
      var beginLine = fileData.indexOf('=        below as the reference number.')+3;
      var endLine = fileData.indexOf('=     SITE SPECIFIC PARAMETERS')-2;
      var cropArray = [];
      for(var i = beginLine;i<=endLine;i++ ){
        if(i == beginLine){
          cropArray.push(fileData[i]);
        }else{
          var splited = fileData[i].split(/(\s+)/);
          cropArray.push(splited[2])
        }
      }

      return cropArray
    }

    function execute(){
      //writeRzwqm();
      plugin.cropInfo()
      console.log(locate)
      //writeRzwqm();
      const exec = require('child_process').exec;
      let stringHere = 'start RZWQMrelease.exe';
      //let stringHere = "C:\\RZWQM2\\projects\\GHG-SE\\GHG-SE-FD\\RZWQMrelease.exe";
      //And run the application from the current folder
      exec(stringHere,{cwd:locate} ,function(err, stdout, stderr){ 
        if (err) {
          alert(err)
          console.log(err)
        }
    // node couldn't execute the command
  // the *entire* stdout and stderr (buffered)
     });
};

    function nsbCalc(){
      //read data from the output
      var output = plugin.readData();
      var yieldRaw = output.yield;
      //console.log(yieldRaw)
      let yield = [];
      var revenue = 0;

      //taking out the final yield with the the number of the day
      yieldRaw.forEach(function(element,index){
        if(element != 0 && yieldRaw[index+1] == 0){
          yield.push(element)
        }
      });   
      
      console.log(yield)   
      //get the revenue from corn
      yield.forEach(function(element){
        revenue += 193.54*(element/1000);
      })

      //if the choice is subirrigation:
      var costConstant = constant["subrirrigation"]["fixed"];
      var fixedCost = 0;
      costConstant.forEach(function(element){
        fixedCost = fixedCost + (Object.values(element)[0])
        })

      var nsb = revenue - fixedCost;

    }

</script>
        
    </body>

    </html>